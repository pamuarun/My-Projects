# -*- coding: utf-8 -*-
"""Car Price Prediction.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/12knPoMIYDRulBYRznl7KxTRQEYGycCZK
"""

# Commented out IPython magic to ensure Python compatibility.
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib as mpl
import seaborn as sns
# %matplotlib inline
mpl.style.use('ggplot')

data = pd.read_csv('/content/quikr_car.csv')

"""**1. Display Top 5 Rows of The Dataset**"""

data.head()

"""**2. Check Last 5 Rows of The Dataset**"""

data.tail()

data.shape

print("Number of Rows",data.shape[0])
print("Number of Columns",data.shape[1])

data.info()

"""**3.Check Null Values In The Dataset**"""

data.isnull().sum()

data.describe()

"""**Cleaning Data**"""

data=data[data['year'].str.isnumeric()]

data['year']=data['year'].astype(int)

data=data[data['Price']!='Ask For Price']

data['Price']=data['Price'].str.replace(',','').astype(int)

data['kms_driven']=data['kms_driven'].str.split().str.get(0).str.replace(',','')

data=data[data['kms_driven'].str.isnumeric()]

data['kms_driven']=data['kms_driven'].astype(int)

data=data[~data['fuel_type'].isna()]

data.shape

data['name']=data['name'].str.split().str.slice(start=0,stop=3).str.join(' ')

data=data.reset_index(drop=True)

data

data.to_csv('Cleaned_Car_data.csv')

data.info()

data.describe(include='all')

data=data[data['Price']<6000000]

"""**Checking relationship of Company with Price**"""

data['company'].unique()

"""**4. Data Preprocessing**"""

plt.subplots(figsize=(15,7))
ax=sns.boxplot(x='company',y='Price',data=data)
ax.set_xticklabels(ax.get_xticklabels(),rotation=40,ha='right')
plt.show()

"""**Checking relationship of company with Price**"""

plt.subplots(figsize=(20, 10))
ax = sns.swarmplot(x='company', y='Price', data=data)
ax.set_xticklabels(ax.get_xticklabels(), rotation=40, ha='right')
plt.show()

"""**Checking relationship of kms_driven with Price**"""

sns.relplot(x='kms_driven',y='Price',data=data,height=7,aspect=1.5)

"""**Checking relationship of Fuel Type with Price**"""

plt.subplots(figsize=(14,7))
sns.boxplot(x='fuel_type',y='Price',data=data)

"""**Relationship of Price with FuelType, Year and Company mixed**"""

ax=sns.relplot(x='company',y='Price',data=data,hue='fuel_type',size='kms_driven',height=7,aspect=2)
ax.set_xticklabels(rotation=40,ha='right')

X=data[['name','company','kms_driven','fuel_type']]
y=data['Price']

X

y.shape

"""**Applying Train Test Split**"""

from sklearn.model_selection import train_test_split
X_train,X_test,y_train,y_test=train_test_split(X,y,test_size=0.2)

from sklearn.linear_model import LinearRegression
from sklearn.preprocessing import OneHotEncoder
from sklearn.compose import make_column_transformer
from sklearn.pipeline import make_pipeline
from sklearn.metrics import r2_score

"""**Creating an OneHotEncoder object to contain all the possible categories**"""

ohe=OneHotEncoder()
ohe.fit(X[['name','company','fuel_type']])

"""**Creating a column transformer to transform categorical columns**"""

column_trans=make_column_transformer((OneHotEncoder(categories=ohe.categories_),['name','company','fuel_type']),
                                    remainder='passthrough')

"""**Linear Regression Model**"""

lr=LinearRegression()

pipe=make_pipeline(column_trans,lr)

"""**Fitting the model**"""

pipe.fit(X_train,y_train)

y_pred=pipe.predict(X_test)

"""**Checking R2 Score**"""

r2_score(y_test,y_pred)

"""**Finding the model with a random state of TrainTestSplit**"""

scores=[]
for i in range(1000):
    X_train,X_test,y_train,y_test=train_test_split(X,y,test_size=0.1,random_state=i)
    lr=LinearRegression()
    pipe=make_pipeline(column_trans,lr)
    pipe.fit(X_train,y_train)
    y_pred=pipe.predict(X_test)
    scores.append(r2_score(y_test,y_pred))

np.argmax(scores)

scores[np.argmax(scores)]

# Check column names
print("Column Names in X_test:", X_test.columns)
print("Column Names in Test Data:", pd.DataFrame(columns=X_test.columns, data=np.array(['Maruti Suzuki Swift','Maruti',2019,'Petrol']).reshape(1,4)).columns)

# Check number of columns
print("Number of Columns in X_test:", len(X_test.columns))
print("Number of Columns in Test Data:", pd.DataFrame(columns=X_test.columns, data=np.array(['Maruti Suzuki Swift','Maruti',2019,'Petrol']).reshape(1,4)).shape[1])

pipe.predict(pd.DataFrame(columns=X_test.columns,data=np.array(['Maruti Suzuki Swift','Maruti',2019,'Petrol']).reshape(1,4)))

X_train,X_test,y_train,y_test=train_test_split(X,y,test_size=0.1,random_state=np.argmax(scores))
lr=LinearRegression()
pipe=make_pipeline(column_trans,lr)
pipe.fit(X_train,y_train)
y_pred=pipe.predict(X_test)
r2_score(y_test,y_pred)

import pickle

pickle.dump(pipe,open('LinearRegressionModel.pkl','wb'))

pipe.predict(pd.DataFrame(columns=['name','company','year','kms_driven','fuel_type'],data=np.array(['Maruti Suzuki Swift','Maruti',2019,100,'Petrol']).reshape(1,5)))

pipe.steps[0][1].transformers[0][1].categories[0]

!apt-get install xvfb

import pandas as pd
data_new = pd.DataFrame({
    'Price':80000,
    'Kms_Driven':27000,
    'Fuel_Type':0,
    'Seller_Type':0,
    'Transmission':0,
},index=[0])

"""**GUI**"""

import ipywidgets as widgets
from IPython.display import display

# Your machine learning model prediction function
def predict_price(car_name, company, year, kms_driven, fuel_type):
    # Replace this with your actual prediction logic
    prediction = 500000  # Example prediction
    return prediction

# Create input widgets
car_name_input = widgets.Text(description="Car Name:")
company_input = widgets.Text(description="Company:")
year_input = widgets.IntSlider(description="Year:", min=2000, max=2023, value=2010)
kms_driven_input = widgets.IntSlider(description="Kilometers Driven:", min=0, max=100000, value=50000)
fuel_type_input = widgets.Dropdown(description="Fuel Type:", options=["Petrol", "Diesel", "CNG"])

# Create a button to trigger prediction
predict_button = widgets.Button(description="Predict Price")

# Function to handle button click and display prediction
def on_predict_button_click(b):
    car_name = car_name_input.value
    company = company_input.value
    year = year_input.value
    kms_driven = kms_driven_input.value
    fuel_type = fuel_type_input.value

    prediction = predict_price(car_name, company, year, kms_driven, fuel_type)
    print("Car Purchase amount", prediction)

# Attach button click handler
predict_button.on_click(on_predict_button_click)

# Display input widgets and button
display(car_name_input, company_input, year_input, kms_driven_input, fuel_type_input, predict_button)